<!DOCTYPE html>
<html>
<head>
    <title>Space Syntax</title>
	<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="leaflet\leaflet.css" />
    <link rel="stylesheet" href="geoman\leaflet-geoman.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.8.0/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="geoman\leaflet-geoman.min.js"></script>
    <script src="http://mejackreed.github.io/Leaflet-IIIF/leaflet-iiif.js"></script>  
    <script src="orthomode\pmOrtho.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <script src="leaflet/choropleth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js" integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="getRequest.js"></script>
    <script type="text/javascript" src="urls.js"></script>

</head>
<body>
    <header >
        <div id="header_title" class="center">
            Graph Analysis on Street Network    
        </div>      
    </header>
<div id="map" >
    <script>
        var IMAGE_NAME = window.location.search.replace('?image=', '')
        var url = `${IIIF_URL}${IMAGE_NAME}/info.json`
        var urlregex = /^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/;

        if (urlregex.test(url)) {
            var iiif_url = url;
        }
        checkGcps();

      function checkGcps() {
            var images = [];
            let xhr = new XMLHttpRequest();
            xhr.open("GET", `${API_URL}getNumGcps/${IMAGE_NAME}`);
        
            xhr.send(null);
            xhr.onload = function() {
                var nGcps = Number(xhr.response)
                var counter = document.getElementById("gcpsCounter");
                counter.innerHTML = `GCPs: ${xhr.response}`;
                counter.style.fontSize = 'medium';

                var item = document.getElementById("item-gcpsCounter");

                var perform_btn = document.getElementById("perform_btn");
                  
                if (nGcps < 1) {
                    item.style.backgroundColor = 'red';
                    perform_btn.style.display='none';
                }
                    
                else if (nGcps < 4) {
                    item.style.backgroundColor = 'blue';
                    perform_btn.style.display='block';
                }
                else
                    item.style.backgroundColor = 'green';
            }
        }
        
        var map = L.map('map', {
            center: [180,180],
            crs: L.CRS.Simple,
            zoom: 0,
            maxZoom: 10,
            // minZoom:1
        });

        var iiifMap = L.tileLayer.iiif(iiif_url, {
            setMaxBounds: true,
            fitBounds: true
        }).addTo(map);

        var PROPER_ZOOM = null
        getRequest(iiif_url, map);

        function onMapClick(e) {
            console.log("proper_zoom: ", PROPER_ZOOM);
            console.log("pixel: ", map.project(e.latlng, PROPER_ZOOM));

        };
        map.on('contextmenu', onMapClick);
        
        map.pm.addControls({
            position: 'topleft',
            drawPolyline: true,
            drawMarker: false,
            drawCircleMarker: false,
            drawRectangle: false,
            drawPolygon: false,
            drawCircle: false,
            drawText: false,
            cutPolygon: false
        });
       
       map.pm.setGlobalOptions({ 
        snappable: true, 
        snapangle: true,
        snapAngleInterval: 90, 
        templineStyle:{ color: 'blue' },
        hintlineStyle:{ color: 'red' },
        pathOptions: {color: 'green'},
        editable: true
    });

        var inputFeatures = L.featureGroup();   
        map.on('pm:create', (e) => {
            inputFeatures.addLayer(e.layer);
       });

        map.on('pm:remove', (e) => {
            inputFeatures.removeLayer(e.layer);
       });

        function exportGeojson() {
            var drawnFeaturesInPixels = L.featureGroup();
            inputFeatures.eachLayer(function(layer){
            for (var i=0; i < layer._latlngs.length;i++) {
                pixel_crs = map.project([layer._latlngs[i]['lat'], layer._latlngs[i]['lng']], PROPER_ZOOM);    
            }
                drawnFeaturesInPixels.addLayer(layer);
            });

            var drawnGeojson = drawnFeaturesInPixels.toGeoJSON();
            for (var i=0; i<drawnGeojson.features.length; i++) {
                for (var j=0; j<drawnGeojson.features[i].geometry.coordinates.length; j++) {
                    var longlat = drawnGeojson.features[i].geometry.coordinates[j];
                    pixel_crs = map.project([longlat[1], longlat[0]], PROPER_ZOOM);        
                    drawnGeojson.features[i].geometry.coordinates[j] = [pixel_crs['x'], pixel_crs['y']];
                }
            }
            sendVector(drawnGeojson);            
       };

       var resultFeatures = L.featureGroup();
       var val_array = [];
        function sendVector(geojsonObject) {
            val_array = []
            var drogi = null;
            let xhr = new XMLHttpRequest();
            xhr.open("POST", `${API_URL}send_vector/`);
            xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            
            geojsonObject['imagename'] = IMAGE_NAME;
            console.log(JSON.stringify(geojsonObject))
            xhr.send(JSON.stringify(geojsonObject));
            xhr.onload = function() {
                inputFeatures.eachLayer(function(layer){
                    inputFeatures.removeLayer(layer);
                    layer.remove();  
                });

                var geojson_res = JSON.parse(xhr.responseText);
                drogi = L.geoJson(geojson_res, {
                    coordsToLatLng: function (coords) {
                        new_coords = map.unproject([coords[0],coords[1]], PROPER_ZOOM);
                        return new L.LatLng(new_coords.lat, new_coords.lng);
                    },
                     style:style,
                     onEachFeature: function (feature, layer) {
                      layer.bindTooltip('Value: ' + feature.properties.betweenn_1.toFixed(2)) ;
                    }
                }).addTo(map)

                val_array = getValues(drogi);
                drogi.eachLayer(function (layer) {
                  inputFeatures.addLayer(layer);
                });
            }
        };

      function download(filename, text) {
          var element = document.createElement('a');
          element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(JSON.stringify(text)));
          element.setAttribute('download', filename);

          element.style.display = 'none';
          document.body.appendChild(element);
          element.click();
          document.body.removeChild(element);
        }

        function getValues(geojsonLayer) {
            var i = 0;
            var values = [];
            geojsonLayer.eachLayer(function(layer) {
                values.push(layer.feature.properties.betweenn_1)
            });
            return values;
        }

        function getColor(d) {
            var mapScale = chroma.scale(['yellow', 'navy']).mode('lch').domain([0,0.4], 5, 'q');
            return mapScale(d)
        }

        colors = chroma.scale(['#ff0000','#2A4858']).mode('lch').colors(6)
        function style(feature) {
            return {
                weight: 7,
                opacity: 1,
                color: getColor(feature.properties.betweenn_1),
                dashArray: '1',
                fillOpacity: 1,
            };
        }

        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [0, 0.1, 0.2, 0.3, 0.4],
                labels = ['Value'];
                div.innerHTML += '<ul>' + labels.join('') + '</ul>'

            // loop through our density intervals and generate a label with a colored square for each interval
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i]) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            return div;
         };
        legend.addTo(map);

         function goToGeoreferenceEditor() {
               window.location.href = `${GEOREFERENCE_URL}?image=${IMAGE_NAME}`
        }
    </script>

</div>

    <div class='grid-container'>
        <div class="grid-item" >
            <button type="button" id="georef_btn"  onclick="goToGeoreferenceEditor()" style="height: 100%; width: 100%; text-align: center;">Georeference a Map</button>
        </div>
        <div class="grid-item" id='item-gcpsCounter' >
            <p id='gcpsCounter'></p>
        </div>
        <div class="grid-item" >
                <button type="button" id="perform_btn"   onclick="exportGeojson()" style="height: 100%; width: 100%; text-align: center;">Perform Analysis</button > 
        </div>
    </div>

</body>
</html>